<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Comparador de Precios</title>
    
    <!-- Fuente Google Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #10b981; /* Verde esmeralda */
            --bg: #f3f4f6;
            --text: #1f2937;
            --border: #e5e7eb;
            --header-bg: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        
        body { background: var(--bg); color: var(--text); padding-bottom: 30px; }

        /* HEADER */
        header {
            background: var(--header-bg); padding: 15px; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #064e3b; }
        
        /* BUSCADOR */
        #searchInput {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db;
            background: #f9fafb; font-size: 16px; outline: none;
            transition: 0.3s;
        }
        #searchInput:focus { border-color: var(--primary); background: #fff; }

        /* BOTONES DE CATEGOR√çA */
        .tabs-container {
            overflow-x: auto; white-space: nowrap; padding: 12px 15px;
            background: var(--bg); -webkit-overflow-scrolling: touch;
            border-bottom: 1px solid var(--border);
            scrollbar-width: none; /* Ocultar scrollbar Firefox */
        }
        .tabs-container::-webkit-scrollbar { display: none; /* Ocultar scrollbar Chrome */ }

        .tab-btn {
            display: inline-block; padding: 8px 16px; margin-right: 8px;
            background: #fff; border: 1px solid #d1d5db; border-radius: 20px;
            font-size: 14px; font-weight: 600; color: #4b5563; cursor: pointer;
            transition: all 0.2s; user-select: none;
        }
        .tab-btn.active {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
        }

        /* CONTENEDOR DE TABLA */
        .table-wrapper {
            margin: 15px; background: white; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;
            border: 1px solid var(--border);
            position: relative;
        }
        
        /* SCROLL HORIZONTAL TABLA */
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        th, td { padding: 12px 15px; text-align: center; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
        
        th { background: #f9fafb; font-weight: 700; color: #374151; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; height: 50px; }
        
        /* COLUMNA FIJA (PRODUCTO) */
        th:first-child, td:first-child {
            position: sticky; left: 0; z-index: 10;
            background: white; text-align: left; font-weight: 700;
            border-right: 2px solid #f3f4f6;
            min-width: 140px; max-width: 180px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.02);
        }
        th:first-child { background: #f9fafb; z-index: 20; }

        /* PRECIOS */
        .price-cell { font-family: 'Inter', monospace; font-size: 14px; color: #4b5563; white-space: nowrap; }
        
        .best-price { 
            background-color: #d1fae5; color: #065f46; 
            font-weight: 800; border-radius: 6px; padding: 4px 8px; 
            display: inline-block; border: 1px solid #a7f3d0;
        }
        
        .no-stock { color: #ef4444; font-size: 11px; font-style: italic; }

        /* LOADING */
        #loader { text-align: center; padding: 40px; color: #6b7280; font-weight: 500; }
        
        /* LINK EXTERNO */
        .link-icon { text-decoration: none; font-size: 12px; color: #3b82f6; }

    </style>
</head>
<body>

    <header>
        <h1>üõí Comparador de Precios</h1>
        <input type="text" id="searchInput" placeholder="üîç Buscar producto (ej: Asado, Pollo)...">
    </header>

    <div class="tabs-container" id="tabsContainer">
        <!-- Los botones de categor√≠as se generan aqu√≠ autom√°ticamente -->
    </div>

    <div id="loader">Cargando datos...</div>

    <div class="table-wrapper">
        <div class="table-scroll">
            <table id="priceTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURACI√ìN ACTUALIZADA CON TUS LINKS
        // ==========================================
        
        const SHEET_KEY = '2PACX-1vR6UTln-nhhZCArBfy7FzU2CO1jel87qmlBquCFWYDmson-uoJeD_Q22K5Yiq6l48rZF71cjhERzAZf';
        
        const CATEGORIAS = [
            { name: "Carnicer√≠a", gid: "1330431075" },
            { name: "Verduler√≠a", gid: "0" },
            { name: "Fiambres y L√°cteos", gid: "279587113" },
            { name: "Higiene", gid: "206948588" },
            { name: "Almac√©n", gid: "229337357" },
            { name: "Diet√©tica", gid: "1226047194" },
            { name: "Mascotas", gid: "501420257" }
        ];

        // Definimos d√≥nde est√°n los precios en tu Google Sheet (Indices de columna comenzando en 0)
        // A=0 (Nombre), B=1 (Link), ... 
        // Seg√∫n tu script: F(5), G(6), H(7), I(8), K(10) son los precios.
        const PRICE_INDICES = [5, 6, 7, 8, 10]; 

        // ==========================================
        // L√ìGICA DE LA APP
        // ==========================================

        let currentData = [];

        async function init() {
            renderTabs();
            await loadCategory(CATEGORIAS[0]); // Cargar la primera categor√≠a al inicio
        }

        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';
            CATEGORIAS.forEach((cat, index) => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${index === 0 ? 'active' : ''}`;
                btn.innerText = cat.name;
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    loadCategory(cat);
                };
                container.appendChild(btn);
            });
        }

        async function loadCategory(category) {
            const loader = document.getElementById('loader');
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            loader.style.display = 'block';
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Link de exportaci√≥n CSV
            const url = `https://docs.google.com/spreadsheets/d/e/${SHEET_KEY}/pub?gid=${category.gid}&single=true&output=csv`;

            try {
                const response = await fetch(url);
                const csvText = await response.text();
                const rows = parseCSV(csvText);

                if (rows.length < 2) {
                    loader.innerText = "No hay datos en esta categor√≠a.";
                    return;
                }

                renderTable(rows);
            } catch (error) {
                console.error(error);
                loader.innerText = "Error cargando los precios. Intenta recargar.";
            } finally {
                loader.style.display = 'none';
            }
        }

        function renderTable(rows) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            const headers = rows[0]; // Fila de encabezados
            currentData = rows.slice(1); // Datos sin encabezado

            // --- 1. RENDERIZAR ENCABEZADOS ---
            let headHtml = '<tr>';
            headHtml += `<th>${headers[0]}</th>`; // Producto
            
            PRICE_INDICES.forEach(idx => {
                // Solo mostramos la columna si tiene t√≠tulo (evita columnas vac√≠as)
                if (headers[idx]) {
                    headHtml += `<th>${headers[idx]}</th>`;
                }
            });
            headHtml += '</tr>';
            thead.innerHTML = headHtml;

            // --- 2. RENDERIZAR FILAS ---
            renderRows(currentData);
        }

        function renderRows(dataRows) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            dataRows.forEach(row => {
                if (!row[0]) return; // Saltar filas vac√≠as

                const tr = document.createElement('tr');
                let rowHtml = `<td>${row[0]}</td>`; // Nombre del producto

                // Calcular m√≠nimo
                let minPrice = Infinity;
                PRICE_INDICES.forEach(idx => {
                    const price = parsePrice(row[idx]);
                    if (price > 0 && price < minPrice) minPrice = price;
                });

                // Generar celdas
                PRICE_INDICES.forEach(idx => {
                    const rawVal = row[idx];
                    const price = parsePrice(rawVal);
                    
                    if (!rawVal || rawVal.trim() === '' || price === 0) {
                        rowHtml += `<td class="no-stock">Sin Stock</td>`;
                    } else {
                        if (price === minPrice) {
                            rowHtml += `<td><span class="best-price">$${formatNumber(price)}</span></td>`;
                        } else {
                            rowHtml += `<td class="price-cell">$${formatNumber(price)}</td>`;
                        }
                    }
                });

                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        // --- BUSCADOR ---
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                const text = row.cells[0].textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        });

        // --- PARSEADOR CSV ROBUSTO ---
        function parseCSV(str) {
            const arr = [];
            let quote = false;
            let col = 0, c = 0;
            for (let r = 0; r < str.length; r++) {
                let char = str[r], next = str[r+1];
                if (!arr[col]) arr[col] = [];
                if (!arr[col][c]) arr[col][c] = "";
                if (char === '"') {
                    if (quote && next === '"') { arr[col][c] += '"'; r++; }
                    else { quote = !quote; }
                } else if (char === ',' && !quote) { c++; }
                else if ((char === '\r' || char === '\n') && !quote) {
                    if (arr[col][c] || c>0) { col++; c = 0; }
                    if (char === '\r' && next === '\n') r++;
                } else { arr[col][c] += char; }
            }
            return arr;
        }

        // --- UTILIDADES DE PRECIO ---
        function parsePrice(str) {
            if (!str) return 0;
            // Si contiene texto de error o "Sin Stock", devolvemos 0
            if (str.toLowerCase().includes('sin') || str.toLowerCase().includes('error')) return 0;
            // Limpiar formato: "$ 1.200,00" -> 1200.00
            let clean = str.toString().replace(/[$.]/g, '').replace(',', '.').trim();
            return parseFloat(clean) || 0;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
        }

        // INICIAR APP
        init();

    </script>
</body>
</html>
