<body>
    <!-- 1. P√≠ldora de Instalaci√≥n PWA -->
    <div id="pwaPill" style="display: none; position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #fff; padding: 10px 16px; border-radius: 50px; font-size: 12px; font-weight: 700; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); align-items: center; gap: 12px; width: max-content; animation: slideUp 0.4s ease-out;">
        <span onclick="closePwaPill()" style="opacity: 0.7; font-size: 16px; cursor: pointer;">&times;</span>
        <span id="pwaText" onclick="installPwa()">INSTALAR APP üõí</span>
    </div>

    <!-- 2. Vista de Detalle de Producto (Modal) -->
    <div id="productFullView">
        <div class="pv-container">
            <div class="pv-header">
                <div style="display:flex; align-items:center; gap:12px;">
                    <button class="pv-back-btn" onclick="closeProductView()"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="logo" style="font-size:16px;">TradingChango</div>
                </div>
                <div class="header-actions">
                    <button class="pv-alert-btn" id="pv-alert-btn" onclick="toggleAlertUI()">
                        <i class="fa-regular fa-bell"></i>
                    </button>
                    <button class="pv-fav-btn" id="pv-fav-btn">
                        <i class="fa-solid fa-cart-shopping"></i>
                    </button>
                    <button class="pv-share-btn" id="pv-share-btn">
                        <i class="fa-solid fa-arrow-up-from-bracket"></i>
                    </button>
                </div>
            </div>
            
            <div class="pv-content">
                <div class="pv-top-info">
                    <div class="pv-img-container" id="pv-img-wrap">
                        <img id="pv-img" src="" alt="Producto">
                    </div>
                    <div class="pv-title-box">
                        <h1 id="pv-name">Cargando...</h1>
                        <div class="pv-best-store" id="pv-best-store">---</div>
                        <div class="pv-price-big" id="pv-price-big">$ 0</div>
                        <div class="pv-avg-price">Precio promedio: <span id="pv-avg-price">$ 0</span></div>
                    </div>
                </div>

                <div class="pv-chart-section">
                    <div class="range-filters" id="pv-range-filters">
                        <button class="range-btn active" onclick="loadPvChart(7, this)">7D</button>
                        <button class="range-btn" onclick="loadPvChart(15, this)">15D</button>
                        <button class="range-btn" onclick="loadPvChart(30, this)">1M</button>
                        <button class="range-btn" onclick="loadPvChart(90, this)">3M</button>
                        <button class="range-btn" onclick="loadPvChart(180, this)">6M</button>
                        <button class="range-btn" onclick="loadPvChart(365, this)">1Y</button>
                    </div>
                    <div class="pv-chart-label">Gr√°fico de tendencias</div> 
                    <span id="pv-perf" class="chart-performance"></span>
                    <div class="chart-wrapper" id="pv-wrap"><canvas id="pv-canvas"></canvas></div>
                </div>

                <div class="pv-market-section">
                    <div class="pv-market-title">Comparaci√≥n de mercado</div>
                    <div id="pv-market-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Contenedor Principal de la App -->
    <div class="app-container">
        <header>
            <div class="top-row">
                <a class="logo-link" onclick="setTab('home')">
                    <div class="logo">
                        <div class="logo-icon-wrapper">
                            <i class="fa-solid fa-cart-shopping"></i>
                            <i class="fa-solid fa-arrow-trend-up"></i>
                        </div>
                        TradingChango
                    </div>
                </a>
                <div class="header-actions">
                    <div class="desktop-links">
                        <a onclick="openPage('acerca_de', 'Acerca de')">Acerca de</a>
                        <a onclick="openPage('terminos', 'T√©rminos')">T√©rminos</a>
                        <a onclick="openPage('contacto', 'Contacto')">Contacto</a>
                    </div>

                    <button class="user-btn" id="userBtn" onclick="openAuth()">
                        <i class="fa-solid fa-circle-user"></i>
                    </button>
                  
                    <button class="user-btn" id="info-celular" onclick="toggleLegalDropdown(event)">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>

                    <div id="legalDropdown" class="legal-dropdown">
                        <a onclick="openPage('acerca_de', 'Acerca de')">Acerca de</a>
                        <a onclick="openPage('terminos', 'T√©rminos')">T√©rminos</a>
                        <a onclick="openPage('contacto', 'Contacto')">Contacto</a>
                    </div>
                    
                    <button class="theme-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon" id="themeIcon"></i></button>
                </div>
            </div>

            <div id="searchBarSection">
                <div class="search-container">
                    <i class="fa-solid fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="BUSCAR PRODUCTO...">
                    <i class="fa-solid fa-circle-xmark clear-search" id="clearSearch" onclick="clearInput()"></i>
                </div>
                <div class="trend-filters" id="headerTrendFilters">
                    <button class="trend-btn" id="btnDown" onclick="setTrendFilter('down')"><i class="fa-solid fa-arrow-trend-down"></i> Precios Bajando</button>
                    <button class="trend-btn" id="btnUp" onclick="setTrendFilter('up')"><i class="fa-solid fa-arrow-trend-up"></i> Precios Subiendo</button>
                </div>
            </div>
            
            <div class="hero-section" id="heroSection">
                <div class="hero-title">Los precios del super como nunca los viste</div>
                <div class="hero-subtitle">Analiz√° los precios, tendencias, y compar√° antes de comprar</div>
            </div>
        </header>

        <div id="loader" class="loader">CONECTANDO A MERCADO...</div>
        <div id="tickerList" class="ticker-list"></div>
        
        <div id="pageView" class="page-view">
            <div class="page-header">
                <div id="pageTitle" class="page-title"></div>
                <div class="back-link" onclick="setTab('home')">Volver <i class="fa-solid fa-chevron-right"></i></div>
            </div>
            <div id="pageContent"></div>
        </div>

        <footer class="app-footer">
            <div>Desarrollado por <a href="https://bento.me/facutom" target="_blank" style="color:var(--text-main); text-decoration:none; font-weight:600;">Facu Tom</a></div>
        </footer>

        <!-- Navegaci√≥n Inferior -->
        <nav class="bottom-nav">
            <button class="nav-item active" id="btn-home" onclick="setTab('home', this)">
                <i class="fa-solid fa-house"></i> Inicio
            </button>
            <button class="nav-item" id="btn-carnes" onclick="setTab('carnes', this)">
                <i class="fa-solid fa-drumstick-bite"></i> Carnes
            </button>
            <button class="nav-item" id="btn-verdu" onclick="setTab('verdu', this)">
                <i class="fa-solid fa-carrot"></i> Verdu
            </button>
            <button class="nav-item" id="btn-varios" onclick="setTab('varios', this)">
                <i class="fa-solid fa-layer-group"></i> Varios
            </button>
            <button class="nav-item" id="btn-favs" onclick="setTab('favs', this)">
                <i class="fa-solid fa-cart-shopping"></i> Chango
                <span class="cart-badge" id="cartBadge">0</span>
            </button>
        </nav>
    </div>

    <!-- 4. Modal de Autenticaci√≥n (Usuario) -->
    <div id="authModal">
        <div style="max-width: 400px; margin: 0 auto; background: var(--bg-app); padding: 30px; border-radius: 20px;">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 id="authTitle" style="font-weight: 800; margin:0;">Crear Cuenta</h2>
                <button onclick="closeAuth()" style="background:none; border:none; font-size:24px; color:var(--text-main); cursor:pointer;">&times;</button>
            </div>

            <form id="registerForm" onsubmit="handleSignUp(event)">
                <div id="extraFields">
                    <input type="text" id="regNombre" placeholder="Nombre" required style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main);">
                    <input type="text" id="regApellido" placeholder="Apellido" required style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main);">
                    <label style="font-size:12px; color:var(--text-muted); margin-bottom:5px; display:block;">Fecha de Nacimiento</label>
                    <input type="date" id="regFecha" required style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main);">
                </div>
                <input type="email" id="regEmail" placeholder="Email" required style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main);">
                <input type="password" id="regPass" placeholder="Contrase√±a (m√≠n. 6 caracteres)" required minlength="6" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main);">
                
                <button type="submit" id="authSubmitBtn" style="width:100%; padding:15px; background:var(--accent); color:#fff; border:none; border-radius:8px; font-weight:700; cursor:pointer;">REGISTRARME</button>
            </form>
            <p style="text-align:center; margin-top:20px; font-size:14px; color:var(--text-muted);">
                <span id="switchText">¬øYa ten√©s cuenta?</span> 
                <a href="#" id="switchBtn" onclick="toggleAuthMode(event)" style="color:var(--accent); font-weight:700; text-decoration:none;">Inici√° Sesi√≥n</a>
            </p>
        </div>
    </div>
   <script>
  // 1. CONFIGURACI√ìN E INICIALIZACI√ìN DE SUPABASE
const SUPABASE_URL = 'https://uginrayldvkhgodvfhta.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnaW5yYXlsZHZraGdvZHZmaHRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwODEzMzcsImV4cCI6MjA4MTY1NzMzN30.hRp7YjVymPnsqbwh8dJjfgKFg77cdd0A5o-ETWYgeiw';
const MONTHS = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

// Inicializaci√≥n del cliente oficial
const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

// 2. VARIABLES DE ESTADO GLOBALES (Solo una vez)
let flatList = [], 
    currentTab = 'home', 
    currentTrendFilter = null, 
    openId = null, 
    configDB = {}, 
    currentChart = null,
    currentUser = null,
    userProfile = null;

// Inicializaci√≥n de Favoritos (Objeto para manejar cantidades)
let favorites = JSON.parse(localStorage.getItem('fav_tickers')) || {};
if (Array.isArray(favorites)) { 
    let newFavs = {};
    favorites.forEach(id => newFavs[id] = 1);
    favorites = newFavs;
    localStorage.setItem('fav_tickers', JSON.stringify(favorites));
}

const paginasEstaticas = { 'acerca_de': 'Acerca de', 'terminos': 'T√©rminos', 'contacto': 'Contacto' };
const getSlug = (name) => name.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');

// 3. FUNCI√ìN DE INICIO (INIT)
async function init() {
    console.log("Iniciando TradingChango...");
    try {
        // Cargar sesi√≥n de usuario
        await initAuth();

        // Cargar Configuraci√≥n (Fetch paralelo para velocidad)
        const [resC, resP, resH] = await Promise.all([
            fetch(`${SUPABASE_URL}/rest/v1/configuracion?select=*`, { headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` } }),
            fetch(`${SUPABASE_URL}/rest/v1/productos?select=*`, { headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` } }),
            fetch(`${SUPABASE_URL}/rest/v1/historial_precios?fecha=gte.${new Date(Date.now() - 7*864e5).toISOString().split('T')[0]}`, { headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` } })
        ]);

        const configRows = await resC.json();
        configRows.forEach(row => configDB[row.clave] = row.valor);

        const rows = await resP.json();
        const hData = await resH.json();
        
        const usedTickers = new Set();
        flatList = rows.map(r => {
            const h7 = hData.filter(h => h.nombre_producto === r.nombre).sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
            let t = generateTicker(r.nombre);
            if(usedTickers.has(t)) t = (t.substring(0,3) + r.id.toString().slice(-1)).toUpperCase();
            usedTickers.add(t);
            return {
                id: r.id, n: r.nombre.trim(), cat: r.categoria, ticker: t,
                p: [r.p_coto||0, r.p_carrefour||0, r.p_dia||0, r.p_jumbo||0],
                urls: [r.url_coto || '#', r.url_carrefour || '#', r.url_dia || '#', r.url_jumbo || '#'],
                h7d: h7.length > 0 ? h7[0].precio_minimo : 0,
                img: r.imagen_url
            }
        });

        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'none';
        updateCartBadge();

        // L√≥gica de rutas iniciales
        const path = window.location.pathname.split('/').filter(p => p !== "");
        if (paginasEstaticas[path[0]]) {
            openPage(path[0], paginasEstaticas[path[0]], false);
        } else if (path.length >= 2) {
            const item = flatList.find(i => getSlug(i.n) === path[1]);
            if (item) openProductView(item.id, false);
            else goHome();
        } else {
            goHome();
        }

        window.onpopstate = handlePopState;

    } catch (e) { 
        console.error("Error en init:", e);
        const loaderEl = document.getElementById('loader');
        if (loaderEl) loaderEl.innerText = "ERROR DE CONEXI√ìN. RECARGUE.";
    }
}

// 4. FUNCIONES DE AUTENTICACI√ìN
async function initAuth() {
    if (!supabase) return;
    const { data: { session } } = await supabase.auth.getSession();
    await handleAuthState(session);
    supabase.auth.onAuthStateChange((_event, session) => handleAuthState(session));
}

async function handleAuthState(session) {
    const userBtn = document.getElementById('userBtn');
    if (session) {
        currentUser = session.user;
        const { data } = await supabase.from('perfiles').select('*').eq('id', currentUser.id).single();
        userProfile = data;
        if (userBtn) userBtn.innerHTML = '<i class="fa-solid fa-circle-user" style="color:var(--color-good)"></i>';
        const modal = document.getElementById('authModal');
        if (modal) modal.style.display = 'none';
    } else {
        currentUser = null;
        if (userBtn) userBtn.innerHTML = '<i class="fa-solid fa-circle-user"></i>';
    }
}

async function handleSignUp(event) {
    event.preventDefault();
    const nombre = document.getElementById('regNombre').value;
    const apellido = document.getElementById('regApellido').value;
    const fecha = document.getElementById('regFecha').value;
    const email = document.getElementById('regEmail').value;
    const pass = document.getElementById('regPass').value;

    const { data, error } = await supabase.auth.signUp({ email, password: pass });
    if (error) { alert(error.message); return; }

    if (data.user) {
        await supabase.from('perfiles').insert([{ id: data.user.id, nombre, apellido, fecha_nacimiento: fecha, email }]);
        alert("¬°Cuenta creada! Revisa tu email.");
        location.reload();
    }
}

function openAuth() { document.getElementById('authModal').style.display = 'block'; }
function closeAuth() { document.getElementById('authModal').style.display = 'none'; }
function showLogin() { document.getElementById('authTitle').innerText = "Iniciar Sesi√≥n"; }

// 5. NAVEGACI√ìN
function handlePopState() {
    const p = window.location.pathname.split('/').filter(x => x !== "");
    if (paginasEstaticas[p[0]]) openPage(p[0], paginasEstaticas[p[0]], false);
    else if (p.length >= 2) {
        const item = flatList.find(i => getSlug(i.n) === p[1]);
        if (item) openProductView(item.id, false);
    } else {
        const fullView = document.getElementById('productFullView');
        if(fullView) fullView.style.display = 'none';
        document.body.style.overflow = 'auto';
        setTab(p[0] || 'home', null, false);
    }
}

function goHome() {
    currentTab = 'home'; currentTrendFilter = null;
    const list = document.getElementById('tickerList');
    if (list) list.style.display = 'block';
    const pv = document.getElementById('pageView');
    if (pv) pv.classList.remove('active');
    document.getElementById('searchBarSection').style.display = 'block';
    document.getElementById('heroSection').style.display = 'block';
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const btn = document.getElementById('btn-home');
    if(btn) btn.classList.add('active');
    renderView();
}

function setTab(t, btn, pushState = true) { 
    currentTab = t; 
    if (pushState) {
        const url = t === 'home' ? '/' : `/${t.toLowerCase()}`;
        history.pushState({tab: t}, '', url);
    }
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
    const target = btn || document.getElementById('btn-' + t);
    if(target) target.classList.add('active'); 
    renderView(); 
}

// 6. VISTA DE PRODUCTO
function openProductView(id, pushState = true) {
    const item = flatList.find(i => i.id == id);
    if (!item) return;
    openId = id;

    if (pushState) {
        const slug = getSlug(item.n);
        const cat = (item.cat || 'varios').toLowerCase().trim();
        history.pushState({ p: id }, '', `/${cat}/${slug}`);
    }

    const stats = getStats(item.p, item.h7d);
    document.getElementById('pv-name').innerText = item.n;
    
    const imgWrap = document.getElementById('pv-img-wrap');
    if (item.img) { document.getElementById('pv-img').src = item.img; imgWrap.style.display = 'block'; }
    else { imgWrap.style.display = 'none'; }

    const stores = ["COTO", "CARREFOUR", "DIA", "JUMBO"];
    document.getElementById('pv-best-store').innerText = `Mejor precio hoy en ${stores[item.p.indexOf(stats.min)]}`;
    document.getElementById('pv-price-big').innerText = `$ ${format(stats.min)}`;

    const precios = item.p.filter(p => p > 0);
    const avg = precios.length > 0 ? (precios.reduce((a, b) => a + b, 0) / precios.length) : 0;
    document.getElementById('pv-avg-price').innerText = `$ ${format(Math.round(avg))}`;

    const favBtn = document.getElementById('pv-fav-btn');
    favBtn.style.color = favorites[item.id] ? 'var(--star-gold)' : 'var(--text-main)';
    favBtn.onclick = () => { toggleFav(item.id, null); favBtn.style.color = favorites[item.id] ? 'var(--star-gold)' : 'var(--text-main)'; };

    document.getElementById('pv-market-list').innerHTML = renderMarket(item, stats.min);
    const view = document.getElementById('productFullView');
    view.style.display = (window.innerWidth >= 1024) ? 'flex' : 'block';
    document.body.style.overflow = 'hidden';
    loadPvChart(7);
}

function closeProductView() {
    document.getElementById('productFullView').style.display = 'none';
    document.body.style.overflow = 'auto';
    history.pushState(null, '', `/${currentTab === 'home' ? '' : currentTab}`);
    openId = null;
    renderView();
}

// 7. ALERTAS Y CHANGO
async function toggleAlertUI() {
    if (!currentUser) { if (confirm("Necesit√°s cuenta para alertas. ¬øCrear una?")) openAuth(); return; }
    const item = flatList.find(i => i.id == openId);
    const target = prompt(`Avisame cuando "${item.n}" baje de $:`, (getStats(item.p, item.h7d).min * 0.9).toFixed(0));
    if (target) {
        await supabase.from('alertas').insert([{ user_id: currentUser.id, product_id: item.id, precio_objetivo: parseFloat(target) }]);
        alert("¬°Alerta configurada!");
    }
}

function toggleFav(id, btn) {
    if (favorites[id]) delete favorites[id]; else favorites[id] = 1;
    localStorage.setItem('fav_tickers', JSON.stringify(favorites));
    updateCartBadge();
    if (currentTab === 'favs') renderView(); else if (btn) btn.classList.toggle('active', !!favorites[id]);
}

function changeQty(id, delta, event) {
    if (event) event.stopPropagation();
    if (favorites[id]) {
        favorites[id] += delta;
        if (favorites[id] < 1) favorites[id] = 1;
        localStorage.setItem('fav_tickers', JSON.stringify(favorites));
        renderView();
    }
}

function updateCartBadge() {
    const b = document.getElementById('cartBadge');
    const count = Object.keys(favorites).length;
    if (b) { b.style.display = count > 0 ? 'flex' : 'none'; b.innerText = count; }
}

// 8. RENDERIZADO PRINCIPAL
function renderView() {
    const container = document.getElementById('tickerList');
    const term = document.getElementById('searchInput').value.toUpperCase();
    const hero = document.getElementById('heroSection');
    const trendFilters = document.getElementById('headerTrendFilters');
    
    if(!container) return;
    container.innerHTML = '';
    let dataToShow = [];

    if (currentTab === 'home') {
        trendFilters.style.display = 'flex';
        hero.style.display = (term || currentTrendFilter) ? 'none' : 'block';
        dataToShow = [...flatList];
    } else if (currentTab === 'favs') {
        trendFilters.style.display = 'none'; hero.style.display = 'none';
        dataToShow = flatList.filter(i => favorites[i.id] !== undefined);
        if (dataToShow.length === 0) { renderEmptyCart(container); return; }
        renderChangoSummary(container, dataToShow);
    } else {
        trendFilters.style.display = 'flex'; hero.style.display = 'none';
        const catMap = { 'carnes': 'Carnes', 'verdu': 'Verdu', 'varios': 'Varios' };
        const catName = catMap[currentTab] || 'Varios';
        dataToShow = flatList.filter(i => i.cat.trim().toLowerCase() === catName.toLowerCase());
    }

    if (term) dataToShow = dataToShow.filter(i => i.n.toUpperCase().includes(term) || i.ticker.toUpperCase().includes(term));
    if (currentTrendFilter && currentTab !== 'favs') {
        dataToShow = dataToShow.filter(item => {
            const s = getStats(item.p, item.h7d);
            return currentTrendFilter === 'up' ? s.isUp : s.isDown;
        });
    }

    dataToShow.forEach(item => {
        const s = getStats(item.p, item.h7d);
        if (s.min === 0) return;
        const currentQty = favorites[item.id] || 1;
        let qtyHtml = currentTab === 'favs' ? `
            <div class="qty-control" onclick="event.stopPropagation()">
                <button class="qty-btn" onclick="changeQty(${item.id}, -1, event)">-</button>
                <span class="qty-num">${currentQty}</span>
                <button class="qty-btn" onclick="changeQty(${item.id}, 1, event)">+</button>
            </div>` : '';

        const card = document.createElement('div');
        card.className = 'ticker-card';
        card.onclick = () => openProductView(item.id);
        card.innerHTML = `
            <div class="ticker-info">
                <div class="t-left"><span class="t-symbol">${item.ticker}</span><span class="t-name">${item.n}</span></div>
                <div class="t-right"><span class="t-price">$${format(s.min)}</span><br><span class="t-change ${s.trendClass}">${s.icon} ${s.spread}%</span></div>
            </div>
            <div style="display:flex; align-items:center;">
                ${qtyHtml}
                <div class="fav-btn ${favorites[item.id] ? 'active' : ''}" onclick="event.stopPropagation(); toggleFav(${item.id}, this)"><i class="fa-solid fa-cart-shopping"></i></div>
            </div>`;
        container.appendChild(card);
    });
}

function renderChangoSummary(container, items) {
    const totals = [0, 0, 0, 0];
    items.forEach(item => {
        const q = favorites[item.id] || 1;
        item.p.forEach((v, i) => { if (v > 0) totals[i] += (v * q); });
    });
    const min = Math.min(...totals.filter(t => t > 0));
    const div = document.createElement('div');
    div.className = 'chango-summary';
    let html = `<div class="pv-market-title" style="font-weight:800; color:var(--text-main);">Tu Chango (Total)</div>`;
    ["COTO", "CARREFOUR", "DIA", "JUMBO"].forEach((n, i) => {
        const isBest = totals[i] === min && min > 0;
        html += `<div class="chango-row ${isBest ? 'best' : ''}"><span>${n}</span><span>$ ${format(totals[i])}</span></div>`;
    });
    div.innerHTML = html; container.appendChild(div);
}

function renderEmptyCart(container) {
    const div = document.createElement('div'); div.className = 'empty-cart-message'; div.style.textAlign = 'center'; div.style.padding = '80px 20px';
    div.innerHTML = `<i class="fa-solid fa-cart-shopping" style="font-size: 50px; margin-bottom: 20px; opacity: 0.2;"></i>
        <div style="font-size: 18px; font-weight: 700; color: var(--text-main);">Tu chango est√° vac√≠o</div>`;
    container.appendChild(div);
}

// 9. HELPERS FINALES
async function loadPvChart(days, btn) {
    if(btn) { btn.parentElement.querySelectorAll('.range-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
    const item = flatList.find(i => i.id == openId);
    const res = await fetch(`${SUPABASE_URL}/rest/v1/historial_precios?nombre_producto=eq.${encodeURIComponent(item.n)}&fecha=gte.${(new Date(Date.now() - days*864e5)).toISOString().split('T')[0]}&order=fecha.asc`, { headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` } });
    const data = await res.json();
    const wrap = document.getElementById('pv-wrap');
    if(!wrap) return;
    wrap.querySelectorAll('.no-data-overlay').forEach(ov => ov.remove());
    if(data.length < 2) {
        const ov = document.createElement('div'); ov.className = 'no-data-overlay'; ov.innerHTML = '<span class="no-data-text">Sin datos suficientes</span>';
        wrap.appendChild(ov); if(currentChart) currentChart.destroy(); return;
    }
    const ctx = document.getElementById('pv-canvas').getContext('2d');
    const isDark = document.documentElement.classList.contains('dark-mode');
    if(currentChart) currentChart.destroy();
    currentChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => { const dt = new Date(d.fecha + 'T12:00:00'); return `${dt.getDate()} ${MONTHS[dt.getMonth()]}.`; }),
            datasets: [{ data: data.map(d => d.precio_minimo), borderColor: isDark ? '#fff' : '#131722', borderWidth: 2, tension: 0, pointRadius: 5 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
}

function getStats(p, h) { 
    const v = p.filter(x=>x>0); if(v.length===0) return {min:0}; 
    const min = Math.min(...v); let diff=0, tc="trend-neutral", icon="-", isUp=false, isDown=false; 
    if(h>0){ diff = ((min-h)/h)*100; if(diff>0.1){ tc="trend-up"; icon="‚ñ≤"; isUp=true; } else if(diff<-0.1){ tc="trend-down"; icon="‚ñº"; isDown=true; } } 
    return {min, spread:Math.abs(diff).toFixed(1), trendClass:tc, icon, isUp, isDown}; 
}

function renderMarket(item, min) {
    const STORES = [{name:"COTO",color:"#ff3b30"},{name:"CARREFOUR",color:"#2962ff"},{name:"DIA",color:"#ff3b30"},{name:"JUMBO",color:"#00c853"}];
    return STORES.map((s, i) => { 
        const p = item.p[i]; const url = item.urls ? item.urls[i] : '#';
        if (p === 0) return `<div class="ob-row" style="opacity:0.5;"><div class="ob-store"><div class="dot" style="background:#444"></div>${s.name}</div><span class="price-link no-price">N/A</span></div>`;
        return `<div class="ob-row"><div class="ob-store"><div class="dot" style="background:${s.color}"></div>${s.name}</div><a href="${url}" target="_blank" rel="noopener" class="price-link ${p===min?'best-val':''}">$${format(p)}</a></div>`; 
    }).join('');
}

function setTrendFilter(t) { currentTrendFilter = (currentTrendFilter === t) ? null : t; document.getElementById('btnUp').classList.toggle('active-up', currentTrendFilter === 'up'); document.getElementById('btnDown').classList.toggle('active-down', currentTrendFilter === 'down'); renderView(); }
function toggleTheme() { document.documentElement.classList.toggle('dark-mode'); localStorage.setItem('theme', document.documentElement.classList.contains('dark-mode')?'dark':'light'); updateThemeIcon(); if(openId) loadPvChart(7); }
function updateThemeIcon() { document.getElementById('themeIcon').className = document.documentElement.classList.contains('dark-mode')?'fa-solid fa-sun':'fa-solid fa-moon'; }
function generateTicker(n) { return n.toUpperCase().replace(/DE|EL|LA|CON|SIN|KG|GRS|ML|\W/g, "").substring(0, 4); }
function format(n) { return new Intl.NumberFormat('es-AR').format(n); }
function toggleLegalDropdown(e) { e.stopPropagation(); const d = document.getElementById('legalDropdown'); d.style.display = d.style.display === 'flex' ? 'none' : 'flex'; }
function clearInput() { document.getElementById('searchInput').value = ''; renderView(); }
function openPage(c, t, pushState = true) { if (pushState) history.pushState({page: c}, '', `/${c}`); document.getElementById('tickerList').style.display = 'none'; document.getElementById('searchBarSection').style.display = 'none'; document.getElementById('heroSection').style.display = 'none'; const v = document.getElementById('pageView'); v.classList.add('active'); document.getElementById('pageTitle').innerText = t; document.getElementById('pageContent').innerHTML = configDB[c] || 'Cargando...'; window.scrollTo(0,0); }

// 10. EVENTOS FINALES
document.getElementById('searchInput').addEventListener('input', renderView);
document.addEventListener('click', () => { if(document.getElementById('legalDropdown')) document.getElementById('legalDropdown').style.display = 'none'; });
document.getElementById('productFullView').addEventListener('click', function(e) { if (window.innerWidth >= 1024 && e.target === this) closeProductView(); });

// Iniciar App
init();
</script>

<!-- Modal o Secci√≥n de Registro/Login -->
<div id="authModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-app); z-index: 2000; overflow-y: auto; padding: 40px 20px;">
    <div style="max-width: 400px; margin: 0 auto;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h2 id="authTitle" style="font-weight: 800;">Crear Cuenta</h2>
            <button onclick="closeAuth()" style="background:none; border:none; font-size:24px; color:var(--text-main); cursor:pointer;">&times;</button>
        </div>

        <form id="registerForm" onsubmit="handleSignUp(event)">
            <input type="text" id="regNombre" placeholder="Nombre" required style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main);">
            <input type="text" id="regApellido" placeholder="Apellido" required style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main);">
            <label style="font-size:12px; color:var(--text-muted); margin-bottom:5px; display:block;">Fecha de Nacimiento</label>
            <input type="date" id="regFecha" required style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main);">
            <input type="email" id="regEmail" placeholder="Email" required style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main);">
            <input type="password" id="regPass" placeholder="Contrase√±a (m√≠n. 6 caracteres)" required minlength="6" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main);">
            
            <button type="submit" style="width:100%; padding:15px; background:var(--accent); color:#fff; border:none; border-radius:8px; font-weight:700; cursor:pointer;">REGISTRARME</button>
        </form>
        
        <p style="text-align:center; margin-top:20px; font-size:14px; color:var(--text-muted);">
            ¬øYa ten√©s cuenta? <a href="#" onclick="showLogin()" style="color:var(--accent); font-weight:700; text-decoration:none;">Inici√° Sesi√≥n</a>
        </p>
    </div>
</div>

  
</body>
</html>
