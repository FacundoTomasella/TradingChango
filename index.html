<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradingChango</title>

<link rel="manifest" href="/manifest.json">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>

<style>
* { box-sizing: border-box; }
body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f5f5f5;
}

.app-container {
    max-width: 600px;
    margin: auto;
    background: #fff;
    min-height: 100vh;
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px;
    border-bottom: 1px solid #eee;
}

nav button {
    background: none;
    border: none;
    font-weight: 600;
    cursor: pointer;
}

.hero-section {
    padding: 16px;
}

.ticker-card {
    padding: 14px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.t-name {
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chart-wrapper {
    height: 240px;
}

.chart-performance {
    padding: 10px;
    font-size: 14px;
}

.loader {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

/* Desktop compact */
@media (min-width: 1024px) {
    .app-container { max-width: 980px; }
    header { padding: 10px 20px; }
    .ticker-card { padding: 12px 16px; }
    .hero-section { padding-top: 10px; }
    .chart-wrapper { height: 220px; }
}
</style>
</head>

<body>
<div class="app-container">

<header>
    <strong>TradingChango</strong>
    <nav>
        <button onclick="navigate('home')">Inicio</button>
        <button onclick="navigate('favs')">Chango</button>
        <button onclick="navigate('acerca_de')">Acerca</button>
    </nav>
</header>

<div id="view"></div>

</div>

<script>
/* =======================
   SPA REDIRECT FIX
======================= */
const redirectPath = sessionStorage.getItem("redirectPath");
if (redirectPath) {
    sessionStorage.removeItem("redirectPath");
    history.replaceState(null, "", redirectPath);
}

/* =======================
   SERVICE WORKER
======================= */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js");
}

/* =======================
   CONSTANTES
======================= */
const MONTHS = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
let pvChart = null;

/* =======================
   MOCK DB (ejemplo)
======================= */
let productos = [];
let configDB = {};

/* =======================
   NAVEGACIÃ“N
======================= */
function navigate(view) {
    history.pushState({}, "", "/" + view);
    renderView(view);
}

window.onpopstate = () => {
    const path = location.pathname.replace("/", "") || "home";
    renderView(path);
};

/* =======================
   RENDER
======================= */
function renderView(view) {
    window.scrollTo(0,0);
    const container = document.getElementById("view");

    if (view === "home") {
        container.innerHTML = `
            <div class="hero-section">
                ${productos.map(p => `
                    <div class="ticker-card" onclick="openProduct(${p.id})">
                        <div class="t-name">${p.producto}</div>
                        <div>$${Number(p.precio_minimo) || 0}</div>
                    </div>
                `).join("")}
            </div>
        `;
        return;
    }

    if (view === "favs") {
        const favs = JSON.parse(localStorage.getItem("favs")) || [];
        if (favs.length === 0) {
            container.innerHTML = `
                <div class="loader">
                    Tu chango estÃ¡ vacÃ­o ðŸ›’<br>
                    AgregÃ¡ productos para comparar precios
                </div>
            `;
            return;
        }
    }

    if (["acerca_de","terminos","contacto"].includes(view)) {
        container.innerHTML = `
            <div class="hero-section" id="pageContent">
                ${configDB[view] || "<p>Contenido no disponible.</p>"}
            </div>
        `;
        return;
    }
}

/* =======================
   PRODUCTO
======================= */
function openProduct(id) {
    const p = productos.find(x => x.id === id);
    document.getElementById("view").innerHTML = `
        <div class="chart-performance">
            <div style="font-weight:600;margin-bottom:4px;">
                Comportamiento del precio del producto
            </div>
            <span id="pv-perf"></span>
        </div>
        <div class="chart-wrapper">
            <canvas id="pvChart"></canvas>
        </div>
    `;
    loadPvChart(p.historial, 7);
}

/* =======================
   AGRUPAR VELAS
======================= */
function agruparVelas(data, dias) {
    const result = [];
    let bucket = [];
    let start = null;

    data.forEach(d => {
        const fecha = new Date(d.fecha);
        if (!start) start = fecha;

        if ((fecha - start) / 864e5 <= dias) {
            bucket.push(d);
        } else {
            result.push(crearVela(bucket, start));
            bucket = [d];
            start = fecha;
        }
    });

    if (bucket.length) result.push(crearVela(bucket, start));
    return result;
}

function crearVela(bucket, fecha) {
    const precios = bucket.map(b => Number(b.precio_minimo) || 0);
    return {
        x: fecha.getTime(),
        o: precios[0],
        h: Math.max(...precios),
        l: Math.min(...precios),
        c: precios[precios.length - 1]
    };
}

/* =======================
   GRÃFICO
======================= */
function loadPvChart(rawData, days) {
    if (pvChart) pvChart.destroy();

    rawData.sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
    const chartData = agruparVelas(rawData, days);

    const ctx = document.getElementById("pvChart").getContext("2d");

    pvChart = new Chart(ctx, {
        type: "candlestick",
        data: {
            datasets: [{
                label: "Precio",
                data: chartData
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: "time",
                    ticks: {
                        callback: v => MONTHS[new Date(v).getMonth()][0]
                    }
                }
            }
        }
    });
}

/* =======================
   INIT
======================= */
renderView(location.pathname.replace("/","") || "home");
</script>

</body>
</html>
