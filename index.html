<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Evitar cach칠 viejo -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>Comparador de Precios</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00a650;
            --bg: #f4f4f4;
            --white: #ffffff;
            --text: #333;
            --border: #e0e0e0;
        }

        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; min-height: 100vh; }

        /* HEADER */
        .app-header {
            background: var(--primary); padding: 15px; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .search-box { position: relative; max-width: 600px; margin: 0 auto; }
        
        #searchInput {
            width: 100%; padding: 12px 15px 12px 45px; box-sizing: border-box;
            border-radius: 25px; border: none; background: var(--white);
            font-size: 16px; outline: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #888; }

        /* TABS CENTRADAS */
        .tabs-wrapper {
            background: var(--white); padding: 12px 0; border-bottom: 1px solid var(--border);
            position: sticky; top: 60px; z-index: 90;
        }
        
        .tabs-container {
            display: flex; justify-content: center; /* CENTRADO */
            flex-wrap: wrap; gap: 8px; padding: 0 10px;
            max-width: 1000px; margin: 0 auto;
        }

        .tab-btn {
            padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 20px;
            font-size: 14px; font-weight: 500; color: #555; cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab-btn.active { background: #333; color: var(--white); font-weight: 700; transform: scale(1.05); }

        /* CONTENIDO PRINCIPAL */
        .main-content { flex: 1; padding: 20px 10px; max-width: 1100px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* TABLA */
        .card-table {
            background: var(--white); border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;
            border: 1px solid var(--border);
        }

        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }

        table { width: 100%; border-collapse: collapse; min-width: 700px; }

        th, td { padding: 14px 10px; text-align: center; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }

        /* Encabezados */
        thead th {
            background: #fafafa; position: sticky; top: 0; z-index: 50;
            font-size: 12px; text-transform: uppercase; color: #666; font-weight: 700;
        }

        /* Columna Producto Fija */
        tbody td:first-child, thead th:first-child {
            position: sticky; left: 0; background: var(--white); z-index: 60;
            text-align: left; border-right: 2px solid #f5f5f5;
            min-width: 160px; max-width: 220px;
            font-weight: 500; font-size: 14px; line-height: 1.4;
        }
        thead th:first-child { background: #fafafa; z-index: 70; }

        /* PRECIOS */
        .price-cell { font-size: 15px; color: #555; font-family: monospace; letter-spacing: -0.5px; }
        
        .winner {
            background: #e8f5e9; color: #1b5e20; font-weight: 800; font-size: 16px;
            padding: 6px 10px; border-radius: 8px; border: 1px solid #c8e6c9; display: inline-block;
        }
        
        .no-stock { color: #ddd; font-size: 24px; font-weight: 300; line-height: 0; vertical-align: middle; }

        /* PAGINACI칍N */
        .pagination {
            display: flex; justify-content: center; align-items: center; gap: 15px;
            padding: 20px; background: var(--white); border-top: 1px solid var(--border);
        }
        .page-btn {
            padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 6px;
            cursor: pointer; font-size: 14px; color: #555;
        }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #f9f9f9; }
        .page-info { font-size: 14px; color: #666; font-weight: 500; }

        /* FOOTER */
        .app-footer {
            background: #222; color: #aaa; text-align: center; padding: 20px;
            font-size: 13px; margin-top: auto;
        }
        .app-footer a { color: var(--primary); text-decoration: none; font-weight: 700; }
        .app-footer a:hover { text-decoration: underline; }

        /* LOADER */
        #loader { text-align: center; padding: 60px; display: none; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* RESPONSIVE */
        @media (max-width: 600px) {
            .tabs-container { justify-content: flex-start; overflow-x: auto; flex-wrap: nowrap; }
            .main-content { padding: 10px 0; }
            .card-table { border-radius: 0; border-left: none; border-right: none; }
        }

    </style>
</head>
<body>

    <div class="app-header">
        <div class="search-box">
            <span class="search-icon">游댌</span>
            <input type="text" id="searchInput" placeholder="Buscar producto...">
        </div>
    </div>

    <div class="tabs-wrapper">
        <div class="tabs-container" id="tabsContainer"></div>
    </div>

    <div class="main-content">
        <div id="loader">
            <div class="spinner"></div>
            <div>Actualizando precios...</div>
        </div>

        <div class="card-table">
            <div class="table-scroll">
                <table id="priceTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <!-- CONTROLES DE PAGINACI칍N -->
            <div class="pagination" id="paginationControls" style="display:none;">
                <button class="page-btn" onclick="prevPage()">Anterior</button>
                <span class="page-info" id="pageInfo">P치gina 1</span>
                <button class="page-btn" onclick="nextPage()">Siguiente</button>
            </div>
            
            <div id="emptyState" style="text-align:center; padding:40px; color:#999; display:none;">
                No se encontraron productos
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="app-footer">
        Desarrollado por <a href="#" target="_blank">Tu Nombre / Marca</a>
    </footer>

    <script>
        // ==========================================
        // 1. CONFIGURACI칍N
        // ==========================================
        // URL DEL JSON EN GITHUB (ESTO ES LO QUE LO HACE R츼PIDO)
        const DATA_URL = 'https://raw.githubusercontent.com/facundotomasella/comparadordeprecios/main/precios.json';

        // PESTA칌AS (Deben coincidir con tu Excel)
        const CATEGORIAS = [
            "Carniceria", "Verduleria", "Fiambres y Lacteos", 
            "Higuiene", "Almacen", "Dietetica", "Mascotas"
        ];

        // ENCABEZADOS DE LA TABLA (Visual)
        const COLUMNAS = [
            { id: 0, name: "Coto", color: "#d32f2f" },
            { id: 1, name: "Carrefour", color: "#1976d2" },
            { id: 2, name: "D칤a", color: "#d32f2f" },
            { id: 3, name: "Jumbo", color: "#388e3c" },
            { id: 4, name: "Extra", color: "#f57c00" }
        ];

        // VARIABLES DE ESTADO
        let DB = {};            // Base de datos completa
        let currentList = [];   // Lista actual filtrada (por categor칤a o b칰squeda)
        let currentPage = 1;    // P치gina actual
        const ITEMS_PER_PAGE = 10; // Productos por p치gina

        // ==========================================
        // 2. INICIALIZACI칍N
        // ==========================================
        async function init() {
            const loader = document.getElementById('loader');
            const tabs = document.getElementById('tabsContainer');
            
            try {
                // Descarga 칰nica del JSON
                const response = await fetch(DATA_URL + '?t=' + Date.now());
                if (!response.ok) throw new Error("Error cargando datos");
                DB = await response.json();

                loader.style.display = 'none';

                // Generar Pesta침as
                tabs.innerHTML = '';
                CATEGORIAS.forEach((cat, index) => {
                    const btn = document.createElement('button');
                    btn.className = `tab-btn ${index === 0 ? 'active' : ''}`;
                    
                    // Emojis decorativos
                    let emoji = "游닍";
                    if(cat.includes("Carniceria")) emoji = "游볼";
                    if(cat.includes("Verduleria")) emoji = "游볹";
                    if(cat.includes("Fiambres")) emoji = "游";
                    if(cat.includes("Higuiene")) emoji = "游빞";
                    if(cat.includes("Almacen")) emoji = "游볾";
                    if(cat.includes("Dietetica")) emoji = "游";
                    if(cat.includes("Mascotas")) emoji = "游냤";

                    btn.innerText = `${emoji} ${cat}`;
                    btn.onclick = () => {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        // Resetear b칰squeda y p치gina al cambiar categor칤a
                        document.getElementById('searchInput').value = '';
                        loadCategory(cat);
                    };
                    tabs.appendChild(btn);
                });

                // Cargar primera categor칤a
                loadCategory(CATEGORIAS[0]);

            } catch (error) {
                console.error(error);
                loader.innerHTML = '<div style="color:red">Error cargando datos. Verifica el script de Google.</div>';
            }
        }

        // Cargar datos de una categor칤a en memoria
        function loadCategory(catName) {
            const rawData = DB[catName] || [];
            currentList = rawData; // Sin filtros al inicio
            currentPage = 1;       // Volver a p치gina 1
            renderPage();
        }

        // ==========================================
        // 3. RENDERIZADO Y PAGINACI칍N
        // ==========================================
        function renderPage() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            const pagination = document.getElementById('paginationControls');
            const emptyState = document.getElementById('emptyState');

            // 1. Encabezados Fijos
            let headHtml = `<tr><th>PRODUCTO</th>`;
            COLUMNAS.forEach(col => {
                headHtml += `<th style="color:${col.color}">${col.name}</th>`;
            });
            headHtml += `</tr>`;
            thead.innerHTML = headHtml;

            // 2. Calcular Paginaci칩n
            const totalItems = currentList.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            
            // Validar l칤mites
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const itemsToShow = currentList.slice(start, end);

            // 3. Renderizar Filas
            tbody.innerHTML = '';
            
            if (itemsToShow.length === 0) {
                emptyState.style.display = 'block';
                pagination.style.display = 'none';
                return;
            } else {
                emptyState.style.display = 'none';
                pagination.style.display = 'flex';
            }

            const fragment = document.createDocumentFragment();

            itemsToShow.forEach(item => {
                const tr = document.createElement('tr');
                
                // Nombre
                let html = `<td>${item.n}</td>`;

                // Calcular M칤nimo (Precios est치n en item.p array: [0, 1, 2, 3, 4])
                let minPrice = Infinity;
                item.p.forEach(p => {
                    if (p > 0 && p < minPrice) minPrice = p;
                });

                // Celdas Precios
                item.p.forEach(price => {
                    if (price > 0) {
                        if (price === minPrice) {
                            // Ganador (Verde)
                            html += `<td><span class="winner">$${formatNumber(price)}</span></td>`;
                        } else {
                            html += `<td><span class="price-cell">$${formatNumber(price)}</span></td>`;
                        }
                    } else {
                        // Sin Stock (Guion grande)
                        html += `<td><span class="no-stock">-</span></td>`;
                    }
                });

                tr.innerHTML = html;
                fragment.appendChild(tr);
            });

            tbody.appendChild(fragment);

            // 4. Actualizar Controles Paginaci칩n
            document.getElementById('pageInfo').innerText = `P치gina ${currentPage} de ${totalPages || 1}`;
            document.querySelectorAll('.page-btn')[0].disabled = (currentPage === 1);
            document.querySelectorAll('.page-btn')[1].disabled = (currentPage === totalPages || totalPages === 0);
        }

        // Funciones de botones Anterior/Siguiente
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderPage();
                document.querySelector('.table-scroll').scrollTop = 0; // Subir al inicio
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(currentList.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderPage();
                document.querySelector('.table-scroll').scrollTop = 0;
            }
        }

        // ==========================================
        // 4. BUSCADOR
        // ==========================================
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            
            // Determinar en qu칠 categor칤a estamos (buscando el bot칩n activo)
            // O mejor: buscar en la categor칤a actual activa en la UI
            const activeBtn = document.querySelector('.tab-btn.active');
            let catName = CATEGORIAS[0];
            if (activeBtn) {
                // Quitamos el emoji para obtener el nombre limpio de la categor칤a
                catName = activeBtn.innerText.substring(3).trim(); 
                // Fix: Asegurar que coincida con las claves del JSON (a veces el emoji ocupa 2 chars)
                const found = CATEGORIAS.find(c => activeBtn.innerText.includes(c));
                if(found) catName = found;
            }

            const rawData = DB[catName] || [];

            // Filtrar
            if (term === "") {
                currentList = rawData;
            } else {
                currentList = rawData.filter(item => item.n.toLowerCase().includes(term));
            }

            currentPage = 1; // Resetear a p치gina 1 al buscar
            renderPage();
        });

        // Formato Moneda
        function formatNumber(num) {
            return new Intl.NumberFormat('es-AR', { minimumFractionDigits: 0 }).format(num);
        }

        // Arrancar
        init();

    </script>
</body>
</html>


